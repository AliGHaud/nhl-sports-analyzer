<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHL Analyzer Test UI</title>
  <style>
    :root {
      --bg: #0b1221;
      --panel: #0f172a;
      --muted: #94a3b8;
      --border: #1f2937;
      --accent: #4f46e5;
      --text: #e2e8f0;
      --good: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", system-ui, -apple-system, sans-serif; margin: 0; padding: 16px; background: radial-gradient(circle at 10% 10%, rgba(79,70,229,0.12) 0, transparent 25%), radial-gradient(circle at 90% 20%, rgba(236,72,153,0.12) 0, transparent 25%), var(--bg); color: var(--text); }
    h1 { margin: 0 0 4px; letter-spacing: 0.02em; font-size: 1.4rem; }
    h3 { margin-top: 0; }
    p { margin: 4px 0; }
    label { font-weight: 600; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.2); margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, input { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: #0b1020; color: var(--text); min-width: 120px; font-size: 1rem; }
    button { padding: 12px 16px; border: none; border-radius: 10px; background: linear-gradient(135deg, #4f46e5, #6366f1); color: #fff; cursor: pointer; font-weight: 700; }
    button:hover { filter: brightness(1.05); }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 960px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr !important; }
      body { padding: 12px; }
      .row { gap: 8px; }
      button, select, input { width: 100%; }
    }
    .pill { display: inline-flex; padding: 6px 10px; border-radius: 999px; background: #111827; border: 1px solid var(--border); gap: 6px; align-items: center; }
    .pill strong { color: #fff; }
    .pill.good { border-color: rgba(22,163,74,0.4); }
    .pill.warn { border-color: rgba(245,158,11,0.4); }
    .pill.bad  { border-color: rgba(239,68,68,0.4); }
    ul { margin: 6px 0 0 20px; }
    .stat-table { width: 100%; border-collapse: collapse; }
    .stat-table td { padding: 6px 4px; border-bottom: 1px solid var(--border); }
    .stat-table tr:last-child td { border-bottom: none; }
    .error { color: var(--bad); font-weight: 600; }
    .success { color: var(--good); }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.12), rgba(255,255,255,0.05)); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 8px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .toggle { background: none; color: var(--muted); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>NHL Matchup Tester</h1>
  <div class="muted">Pick teams and dates, then run analysis. Powered by your local API.</div>

  <div class="card">
    <div class="row">
      <label for="home">Home</label>
      <select id="home"></select>
      <label for="away">Away</label>
      <select id="away"></select>
    </div>
    <div class="row" style="margin-top: 12px;">
      <label for="start">Start date</label>
      <input id="start" type="date" />
      <label for="end">End date</label>
      <input id="end" type="date" />
      <label class="row" style="gap:6px;"><input id="force" type="checkbox" /> Force refresh</label>
      <button id="go">Analyze Matchup</button>
      <button id="goTeam" style="background: linear-gradient(135deg, #22c55e, #16a34a);">Analyze Team</button>
      <button id="pickBtn" style="background: linear-gradient(135deg, #f59e0b, #f97316);">Pick of the Day</button>
    </div>
  </div>

  <div id="pickCard" class="card" style="display:none;"></div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>
        <h3 style="margin:0;">League Stats</h3>
        <div class="muted">NHL team stats (NHL API + MoneyPuck).</div>
      </div>
      <button id="refreshStats">Refresh</button>
    </div>
    <div id="statsTable" class="muted">Loading...</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>
        <h3 style="margin:0;">Today's Games</h3>
        <div id="todayMeta" class="muted">Auto-loads today's schedule.</div>
      </div>
      <div class="row" style="gap:8px;">
        <label class="row" style="gap:6px; align-items:center;"><input id="oddsOnly" type="checkbox" /> Odds only</label>
        <button id="refreshToday">Refresh</button>
      </div>
    </div>
    <div id="todayGames" class="grid" style="margin-top:10px; gap:10px;"></div>
  </div>

  <div id="summary" class="card" style="display:none;"></div>
  <div class="grid grid-2">
    <div id="reasons" class="card" style="display:none;"></div>
    <div id="ev" class="card" style="display:none;"></div>
  </div>
  <div id="teams" class="grid grid-2"></div>
  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h3 style="margin:0;">Raw JSON</h3>
      <button id="toggleRaw" class="toggle">Show</button>
    </div>
    <div id="raw" style="display:none; margin-top:8px;">
      <pre id="out">{ }</pre>
    </div>
  </div>

  <script>
    const homeSel = document.getElementById('home');
    const awaySel = document.getElementById('away');
    const startInp = document.getElementById('start');
    const endInp = document.getElementById('end');
    const forceChk = document.getElementById('force');
    const out = document.getElementById('out');
    const summaryEl = document.getElementById('summary');
    const reasonsEl = document.getElementById('reasons');
    const evEl = document.getElementById('ev');
    const teamsEl = document.getElementById('teams');
    const rawEl = document.getElementById('raw');
    const todayGamesEl = document.getElementById('todayGames');
    const todayMeta = document.getElementById('todayMeta');
    const refreshStatsBtn = document.getElementById('refreshStats');
    const statsTable = document.getElementById('statsTable');
    const refreshTodayBtn = document.getElementById('refreshToday');
    const goTeamBtn = document.getElementById('goTeam');
    const pickBtn = document.getElementById('pickBtn');
    const pickCard = document.getElementById('pickCard');
    const toggleRawBtn = document.getElementById('toggleRaw');
    const rawContainer = document.getElementById('raw');
    const oddsOnlyChk = document.getElementById('oddsOnly');

    async function loadTeams() {
      try {
        const res = await fetch('/teams');
        const data = await res.json();
        (data.teams || []).forEach(code => {
          const opt1 = document.createElement('option');
          opt1.value = code; opt1.textContent = code;
          const opt2 = opt1.cloneNode(true);
          homeSel.appendChild(opt1);
          awaySel.appendChild(opt2);
        });
        // Preselect something
        if (homeSel.options.length > 1) {
          homeSel.value = homeSel.options[0].value;
          awaySel.value = homeSel.options[1].value;
        }
      } catch (err) {
        out.textContent = 'Error loading teams: ' + err;
      }
    }

    function fmt(num, digits = 2) {
      if (num === null || num === undefined || Number.isNaN(num)) return '-';
      return Number(num).toFixed(digits).replace(/\.00$/, '');
    }

    function renderSummary(data) {
      const { params, side } = data;
      const headline = `${params.away} @ ${params.home}`;
      summaryEl.innerHTML = `
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div>
            <h3 style="margin:0;">${headline}</h3>
            <div class="muted">${params.start_date} to ${params.end_date} ${params.force_refresh ? '(fresh)' : ''}</div>
          </div>
          <div class="pill warn"><strong>Lean:</strong> ${side.lean}</div>
        </div>
        <div style="margin-top:12px;" class="row">
          <div class="pill"><strong>${params.home}</strong> score ${fmt(side.home_score)}</div>
          <div class="pill"><strong>${params.away}</strong> score ${fmt(side.away_score)}</div>
        </div>
      `;
      summaryEl.style.display = 'block';
    }

    function renderReasons(side) {
      const homeList = (side.reasons.home_reasons || []).map(r => `<li>${r}</li>`).join('') || '<li>No strong reasons</li>';
      const awayList = (side.reasons.away_reasons || []).map(r => `<li>${r}</li>`).join('') || '<li>No strong reasons</li>';
      reasonsEl.innerHTML = `
        <h3>Reasons</h3>
        <div class="grid grid-2">
          <div><strong>Home reasons</strong><ul>${homeList}</ul></div>
          <div><strong>Away reasons</strong><ul>${awayList}</ul></div>
        </div>
      `;
      reasonsEl.style.display = 'block';
    }

    function renderEV(ev, params) {
      if (!ev) { evEl.style.display = 'none'; return; }
      evEl.innerHTML = `
        <h3>EV & Odds</h3>
        <p class="muted">From ESPN odds (if available)</p>
        <div class="grid grid-2">
          <div class="pill"><strong>${params.home}</strong> ML ${fmt(ev.odds.home_ml,0)}</div>
          <div class="pill"><strong>${params.away}</strong> ML ${fmt(ev.odds.away_ml,0)}</div>
        </div>
        <table class="stat-table" style="margin-top:10px;">
          <tr><td>Model prob ${params.home}</td><td>${fmt(ev.model_prob.home*100)}%</td></tr>
          <tr><td>Model prob ${params.away}</td><td>${fmt(ev.model_prob.away*100)}%</td></tr>
          <tr><td>Edge ${params.home}</td><td>${fmt(ev.edge_pct.home)}%</td></tr>
          <tr><td>Edge ${params.away}</td><td>${fmt(ev.edge_pct.away)}%</td></tr>
          <tr><td>EV (1u) ${params.home}</td><td>${fmt(ev.ev_units.home,3)}u (grade ${ev.grades.home})</td></tr>
          <tr><td>EV (1u) ${params.away}</td><td>${fmt(ev.ev_units.away,3)}u (grade ${ev.grades.away})</td></tr>
        </table>
      `;
      evEl.style.display = 'block';
    }

    function renderTeamCard(profile, label) {
      const streak = profile.streak;
      const rest = profile.rest || {};
      const restText = rest.days_since_last === null || rest.days_since_last === undefined
        ? '-'
        : `${rest.days_since_last}d${rest.is_back_to_back ? ' (B2B)' : ''}`;
      return `
        <div class="card">
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">${label}: ${profile.team}</h3>
            <div class="pill">${streak.length ? `${streak.length}-game ${streak.type === 'W' ? 'win' : 'loss'} streak` : 'No streak'}</div>
          </div>
          <table class="stat-table">
            <tr><td>Full record</td><td>${profile.full.wins}-${profile.full.losses} (${profile.full.games} gp)</td></tr>
            <tr><td>GF/GA avg</td><td>${fmt(profile.full.avg_for)} / ${fmt(profile.full.avg_against)}</td></tr>
            <tr><td>Last 5</td><td>${profile.last5.wins}-${profile.last5.losses} | GF/GA ${fmt(profile.last5.avg_for)} / ${fmt(profile.last5.avg_against)}</td></tr>
            <tr><td>Last 10</td><td>${profile.last10.wins}-${profile.last10.losses} | GF/GA ${fmt(profile.last10.avg_for)} / ${fmt(profile.last10.avg_against)}</td></tr>
            <tr><td>Home</td><td>${profile.home.wins}-${profile.home.losses} (avg ${fmt(profile.home.avg_for)} / ${fmt(profile.home.avg_against)})</td></tr>
            <tr><td>Away</td><td>${profile.away.wins}-${profile.away.losses} (avg ${fmt(profile.away.avg_for)} / ${fmt(profile.away.avg_against)})</td></tr>
            <tr><td>3+ goals last 5</td><td>${profile.high_scoring_last5.count}/${profile.high_scoring_last5.total}</td></tr>
            <tr><td>Rest</td><td>${restText}</td></tr>
          </table>
        </div>
      `;
    }

    function renderTeams(profiles) {
      teamsEl.innerHTML = `
        ${renderTeamCard(profiles.home, 'Home')}
        ${renderTeamCard(profiles.away, 'Away')}
      `;
    }

    function renderPick(data) {
      const pick = data.pick;
      const tz = data.timezone || 'Local';
      if (!pick) {
        pickCard.style.display = 'block';
        pickCard.innerHTML = `
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">Pick of the Day</h3>
            <div class="pill warn">No pick today</div>
          </div>
          <p class="muted" style="margin-top:8px;">${data.reason || 'No qualifying edge met the thresholds.'}</p>
          <div class="muted" style="margin-top:6px;">Date ${data.date} (${tz})</div>
        `;
        return;
      }
      pickCard.style.display = 'block';
      pickCard.innerHTML = `
        <div class="row" style="justify-content: space-between; align-items: center;">
          <h3 style="margin:0;">Pick of the Day</h3>
          <div class="pill good">${pick.side} ML ${fmt(pick.odds,0)} (grade ${pick.grade})</div>
        </div>
        <div class="row" style="margin-top:8px; gap:12px;">
          <div class="pill"><strong>Matchup:</strong> ${pick.matchup.away} @ ${pick.matchup.home}</div>
          <div class="pill"><strong>Edge:</strong> ${fmt(pick.edge_pct)}%</div>
          <div class="pill"><strong>EV:</strong> ${fmt(pick.ev_units,3)}u</div>
          <div class="pill"><strong>Model:</strong> ${fmt(pick.model_prob*100)}%</div>
        </div>
        <div style="margin-top:8px;">
          <div class="muted">Reasons:</div>
          <ul>${(pick.reasons || []).map(r => `<li>${r}</li>`).join('') || '<li>No reasons available</li>'}</ul>
        </div>
        <div class="muted" style="margin-top:6px;">Date ${data.date} (${tz})${data.params?.force_refresh ? ' (fresh)' : ''}</div>
      `;
    }

    async function loadPick() {
      pickCard.style.display = 'block';
      pickCard.innerHTML = '<div class="muted">Loading pick of the day...</div>';
      const params = new URLSearchParams();
      if (forceChk.checked) params.set('force_refresh', 'true');
      // use cache by default (do not set cache=false)
      try {
        const res = await fetch('/nhl/pick?' + params.toString());
        const body = await res.json();
        if (!res.ok) {
          pickCard.innerHTML = `<div class="error">Error: ${body.detail || 'Request failed'}</div>`;
          return;
        }
        renderPick(body);
      } catch (err) {
        pickCard.innerHTML = `<div class="error">Error: ${err}</div>`;
      }
    }

    async function analyzeTeam() {
      const params = new URLSearchParams();
      params.set('team', homeSel.value);
      if (startInp.value) params.set('start_date', startInp.value);
      if (endInp.value) params.set('end_date', endInp.value);
      if (forceChk.checked) params.set('force_refresh', 'true');

      summaryEl.style.display = 'none';
      reasonsEl.style.display = 'none';
      evEl.style.display = 'none';
      teamsEl.innerHTML = '';
      out.textContent = 'Loading...';

      try {
        const res = await fetch('/nhl/team?' + params.toString());
        const body = await res.json();
        if (!res.ok) {
          out.textContent = 'Error: ' + (body.detail || 'Request failed');
          summaryEl.style.display = 'none';
          reasonsEl.style.display = 'none';
          evEl.style.display = 'none';
          teamsEl.innerHTML = '';
          return;
        }
        out.textContent = JSON.stringify(body, null, 2);
        const profile = body.profile;
        summaryEl.innerHTML = `
          <div class="row" style="justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin:0;">Team: ${profile.team}</h3>
              <div class="muted">${body.params.start_date} to ${body.params.end_date} ${body.params.force_refresh ? '(fresh)' : ''}</div>
            </div>
            <div class="pill"><strong>Games:</strong> ${profile.full.games}</div>
          </div>
        `;
        summaryEl.style.display = 'block';
        renderSingleTeam(profile);
      } catch (err) {
        out.textContent = 'Error: ' + err;
      }
    }
    function renderSingleTeam(profile) {
      teamsEl.innerHTML = `
        ${renderTeamCard(profile, 'Team')}
      `;
    }

    async function loadStats(forceRefresh = false) {
      statsTable.innerHTML = '<div class="skeleton" style="height:40px;"></div>';
      const params = forceRefresh ? '?force_refresh=true' : '';
      try {
        const res = await fetch('/nhl/stats' + params);
        const body = await res.json();
        if (!res.ok) {
          statsTable.innerHTML = `<div class="error">Error: ${body.detail || 'failed to load stats'}</div>`;
          return;
        }
        const rows = body.teams || [];
        if (!rows.length) {
          statsTable.innerHTML = '<div class="muted">No stats available.</div>';
          return;
        }
        const header = `
          <div class="row" style="gap:8px; font-weight:600; border-bottom:1px solid var(--border); padding-bottom:6px;">
            <div style="width:60px;">Team</div>
            <div style="width:90px;">xG%</div>
            <div style="width:90px;">HD%</div>
            <div style="width:90px;">PP%</div>
            <div style="width:90px;">PK%</div>
            <div style="width:90px;">FO%</div>
            <div style="width:90px;">S/G</div>
            <div style="width:90px;">SA/G</div>
          </div>
        `;
        const bodyHtml = rows.map((r) => {
          const adv = r.adv || {};
          const nhl = r.nhl || {};
          return `
            <div class="row" style="gap:8px; padding:4px 0; border-bottom:1px solid var(--border);">
              <div style="width:60px;">${r.team}</div>
              <div style="width:90px;">${fmt(adv.xgf_pct)}</div>
              <div style="width:90px;">${fmt(adv.hdf_pct)}</div>
              <div style="width:90px;">${adv.pp ? fmt(adv.pp) : fmt(nhl.pp_pct)}</div>
              <div style="width:90px;">${adv.pk ? fmt(adv.pk) : fmt(nhl.pk_pct)}</div>
              <div style="width:90px;">${fmt(nhl.fo_pct)}</div>
              <div style="width:90px;">${fmt(nhl.shots_for)}</div>
              <div style="width:90px;">${fmt(nhl.shots_against)}</div>
            </div>
          `;
        }).join('');
        statsTable.innerHTML = header + bodyHtml;
      } catch (err) {
        statsTable.innerHTML = `<div class="error">Error: ${err}</div>`;
      }
    }

    async function loadToday(forceRefresh = false) {
      todayGamesEl.innerHTML = '<div class="skeleton" style="height:48px;"></div>';
      const params = forceRefresh ? '?force_refresh=true' : '';
      try {
        const res = await fetch('/nhl/today' + params);
        const body = await res.json();
        if (!res.ok) {
          todayGamesEl.innerHTML = `<div class="error">Error: ${body.detail || 'failed to load'}</div>`;
          return;
        }
        const tz = body.timezone || 'Local';
        todayMeta.textContent = `Games for ${body.date} (${tz})${body.force_refresh ? ' (fresh)' : ''}`;
        const games = body.games || [];
        if (!games.length) {
          todayGamesEl.innerHTML = '<div class="muted">No games found for today.</div>';
          return;
        }
        const filtered = oddsOnlyChk.checked ? games.filter(g => g.odds) : games;
        if (!filtered.length) {
          todayGamesEl.innerHTML = '<div class="muted">No games match the current filter.</div>';
          return;
        }
        todayGamesEl.innerHTML = filtered.map((g, idx) => `
          <div class="card" style="padding:12px; margin:0;">
            <div class="row" style="justify-content: space-between; align-items: center;">
              <div><strong>${g.away} @ ${g.home}</strong></div>
            </div>
            <div class="row" style="justify-content: space-between; align-items: center; margin-top:6px;">
              <div class="muted">${g.odds ? `Odds: ${g.odds.away_ml > 0 ? '+'+g.odds.away_ml : g.odds.away_ml} / ${g.odds.home_ml > 0 ? '+'+g.odds.home_ml : g.odds.home_ml}` : 'Odds unavailable'}</div>
              <button data-home="${g.home}" data-away="${g.away}" class="analyze-btn">Analyze</button>
            </div>
          </div>
        `).join('');
        // Wire up buttons
        todayGamesEl.querySelectorAll('.analyze-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            homeSel.value = btn.getAttribute('data-home');
            awaySel.value = btn.getAttribute('data-away');
            analyze();
          });
        });
      } catch (err) {
        todayGamesEl.innerHTML = `<div class="error">Error: ${err}</div>`;
      }
    }

    async function analyze() {
      const params = new URLSearchParams();
      params.set('home', homeSel.value);
      params.set('away', awaySel.value);
      if (startInp.value) params.set('start_date', startInp.value);
      if (endInp.value) params.set('end_date', endInp.value);
      if (forceChk.checked) params.set('force_refresh', 'true');
      summaryEl.style.display = 'none';
      reasonsEl.style.display = 'none';
      evEl.style.display = 'none';
      teamsEl.innerHTML = '';
      out.textContent = 'Loading...';
      try {
        const res = await fetch('/nhl/matchup?' + params.toString());
        const body = await res.json();
        if (!res.ok) {
          out.textContent = 'Error: ' + (body.detail || 'Request failed');
          summaryEl.style.display = 'none';
          reasonsEl.style.display = 'none';
          evEl.style.display = 'none';
          teamsEl.innerHTML = '';
          return;
        }
        out.textContent = JSON.stringify(body, null, 2);
        renderSummary(body);
        renderReasons(body.side);
        renderEV(body.ev, body.params);
        renderTeams(body.profiles);
      } catch (err) {
        out.textContent = 'Error: ' + err;
      }
    }

    document.getElementById('go').addEventListener('click', analyze);
    goTeamBtn.addEventListener('click', analyzeTeam);
    pickBtn.addEventListener('click', loadPick);
    refreshTodayBtn.addEventListener('click', loadToday);
    oddsOnlyChk.addEventListener('change', () => loadToday());
    refreshStatsBtn.addEventListener('click', () => loadStats(true));
    toggleRawBtn.addEventListener('click', () => {
      const open = rawContainer.style.display === 'block';
      rawContainer.style.display = open ? 'none' : 'block';
      toggleRawBtn.textContent = open ? 'Show' : 'Hide';
    });
    loadTeams();
    loadToday();
    loadPick();
    loadStats();
  </script>
</body>
</html>
